{% if no_data %}
    <div style="padding:2rem; text-align:center; color:var(--color-text-muted);">Aucune donnée disponible</div>
{% elif no_errors %}
    <div style="padding:2rem; text-align:center; color:var(--color-text-muted);">Aucune erreur à afficher</div>
{% else %}

<div style="display:flex; flex-direction:column; gap:1.5rem;">
    <!-- Top 3 erreurs -->
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1.5rem;">
        <div style="background:var(--color-surface); border:1px solid var(--color-border); border-radius:var(--radius); padding:1.5rem;">
            <h4 style="font-size:1.05rem; font-weight:700; margin:0 0 1rem 0; color:var(--color-text);">Top 3 erreurs (EVI + Downstream)</h4>
            {% if top_all %}
            <div class="mac-table-container">
                <table class="mac-table" id="top-all-table">
                    <thead>
                        <tr>
                            <th class="sortable">Moment</th>
                            <th class="sortable">Step</th>
                            <th class="sortable">Code</th>
                            <th class="sortable">Type</th>
                            <th class="sortable" data-type="number">Occurrences</th>
                            <th class="sortable" data-type="number">%</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in top_all %}
                        <tr>
                            <td>{{ row.moment_label }}</td>
                            <td>{{ row.step }}</td>
                            <td>{{ row.code }}</td>
                            <td>{{ row.type }}</td>
                            <td style="text-align:right;" data-sort-value="{{ row.Occurrences }}">{{ row.Occurrences }}</td>
                            <td style="text-align:right;" data-sort-value="{{ '%.2f'|format(row.percent) }}">{{ '%.2f'|format(row.percent) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div style="padding:1rem; color:var(--color-text-muted); text-align:center;">Aucune erreur</div>
            {% endif %}
        </div>

        <div style="background:var(--color-surface); border:1px solid var(--color-border); border-radius:var(--radius); padding:1.5rem;">
            <h4 style="font-size:1.05rem; font-weight:700; margin:0 0 1rem 0; color:var(--color-text);">Détail Top 3 par site</h4>
            {% if detail_all_pivot.columns %}
            <div class="mac-table-container" style="max-height:400px;">
                <table class="mac-table" id="detail-all-table">
                    <thead>
                        <tr>
                            {% for col in detail_all_pivot.columns %}
                            <th class="sortable {% if col != 'Site' and col != 'Total Charges' %}multiline{% endif %}" {% if col != 'Site' %}data-type="number"{% endif %}>{{ col }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in detail_all_pivot.rows %}
                        <tr>
                            {% for col in detail_all_pivot.columns %}
                            <td style="text-align:{{ 'left' if col == 'Site' else 'right' }};">{{ row[col] }}</td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div style="padding:1rem; color:var(--color-text-muted); text-align:center;">Aucun détail</div>
            {% endif %}
        </div>
    </div>

    <!-- Top 3 EVI -->
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1.5rem;">
        <div style="background:var(--color-surface); border:1px solid var(--color-border); border-radius:var(--radius); padding:1.5rem;">
            <h4 style="font-size:1.05rem; font-weight:700; margin:0 0 1rem 0; color:var(--color-text);">Top 3 erreurs EVI</h4>
            {% if top_evi %}
            <div class="mac-table-container">
                <table class="mac-table" id="top-evi-table">
                    <thead>
                        <tr>
                            <th class="sortable">Moment</th>
                            <th class="sortable">Step</th>
                            <th class="sortable">Code EVI</th>
                            <th class="sortable" data-type="number">Occurrences</th>
                            <th class="sortable" data-type="number">%</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in top_evi %}
                        <tr>
                            <td>{{ row.moment_label }}</td>
                            <td>{{ row.step }}</td>
                            <td>{{ row.code }}</td>
                            <td style="text-align:right;" data-sort-value="{{ row.Occurrences }}">{{ row.Occurrences }}</td>
                            <td style="text-align:right;" data-sort-value="{{ '%.2f'|format(row.percent) }}">{{ '%.2f'|format(row.percent) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div style="padding:1rem; color:var(--color-text-muted); text-align:center;">Aucune erreur EVI</div>
            {% endif %}
        </div>

        <div style="background:var(--color-surface); border:1px solid var(--color-border); border-radius:var(--radius); padding:1.5rem;">
            <h4 style="font-size:1.05rem; font-weight:700; margin:0 0 1rem 0; color:var(--color-text);">Détail EVI Top 3 par site</h4>
            {% if detail_evi_pivot.columns %}
            <div class="mac-table-container" style="max-height:400px;">
                <table class="mac-table" id="detail-evi-table">
                    <thead>
                        <tr>
                            {% for col in detail_evi_pivot.columns %}
                            <th class="sortable {% if col != 'Site' and col != 'Total Charges' %}multiline{% endif %}" {% if col != 'Site' %}data-type="number"{% endif %}>{{ col }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in detail_evi_pivot.rows %}
                        <tr>
                            {% for col in detail_evi_pivot.columns %}
                            <td style="text-align:{{ 'left' if col == 'Site' else 'right' }};">{{ row[col] }}</td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div style="padding:1rem; color:var(--color-text-muted); text-align:center;">Aucun détail</div>
            {% endif %}
        </div>
    </div>

    <!-- Top 3 Downstream -->
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1.5rem;">
        <div style="background:var(--color-surface); border:1px solid var(--color-border); border-radius:var(--radius); padding:1.5rem;">
            <h4 style="font-size:1.05rem; font-weight:700; margin:0 0 1rem 0; color:var(--color-text);">Top 3 erreurs Downstream</h4>
            {% if top_ds %}
            <div class="mac-table-container">
                <table class="mac-table" id="top-ds-table">
                    <thead>
                        <tr>
                            <th class="sortable">Moment</th>
                            <th class="sortable">Step</th>
                            <th class="sortable">Code PC</th>
                            <th class="sortable" data-type="number">Occurrences</th>
                            <th class="sortable" data-type="number">%</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in top_ds %}
                        <tr>
                            <td>{{ row.moment_label }}</td>
                            <td>{{ row.step }}</td>
                            <td>{{ row.code }}</td>
                            <td style="text-align:right;" data-sort-value="{{ row.Occurrences }}">{{ row.Occurrences }}</td>
                            <td style="text-align:right;" data-sort-value="{{ '%.2f'|format(row.percent) }}">{{ '%.2f'|format(row.percent) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div style="padding:1rem; color:var(--color-text-muted); text-align:center;">Aucune erreur Downstream</div>
            {% endif %}
        </div>

        <div style="background:var(--color-surface); border:1px solid var(--color-border); border-radius:var(--radius); padding:1.5rem;">
            <h4 style="font-size:1.05rem; font-weight:700; margin:0 0 1rem 0; color:var(--color-text);">Détail Downstream Top 3 par site</h4>
            {% if detail_ds_pivot.columns %}
            <div class="mac-table-container" style="max-height:400px;">
                <table class="mac-table" id="detail-ds-table">
                    <thead>
                        <tr>
                            {% for col in detail_ds_pivot.columns %}
                            <th class="sortable {% if col != 'Site' and col != 'Total Charges' %}multiline{% endif %}" {% if col != 'Site' %}data-type="number"{% endif %}>{{ col }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in detail_ds_pivot.rows %}
                        <tr>
                            {% for col in detail_ds_pivot.columns %}
                            <td style="text-align:{{ 'left' if col == 'Site' else 'right' }};">{{ row[col] }}</td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div style="padding:1rem; color:var(--color-text-muted); text-align:center;">Aucun détail</div>
            {% endif %}
        </div>
    </div>

    <!-- EVI + DS Moment × Code -->
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1.5rem;">
        <div style="background:var(--color-surface); border:1px solid var(--color-border); border-radius:var(--radius); padding:1.5rem;">
            <h4 style="font-size:1.05rem; font-weight:700; margin:0 0 1rem 0; color:var(--color-text);">EVI — Moment × Code</h4>
            {% if evi_moment_code %}
            <div class="mac-table-container">
                <table class="mac-table" id="evi-moment-code-table">
                    <thead>
                        <tr>
                            <th class="sortable">Moment</th>
                            <th class="sortable">Step</th>
                            <th class="sortable">Code</th>
                            <th class="sortable" data-type="number">Somme Charge_NOK</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in evi_moment_code %}
                        <tr>
                            <td>{{ row["Moment"] }}</td>
                            <td>{{ row["Step"] }}</td>
                            <td>{{ row["Code"] }}</td>
                            <td style="text-align:right;">{{ row["Somme de Charge_NOK"] }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <h4 style="font-size:1.05rem; font-weight:700; margin:1.5rem 0 1rem 0; color:var(--color-text);">EVI — Moment × Code × Site</h4>
            {% if evi_moment_code_site %}
            <div class="mac-table-container">
                <table class="mac-table" id="evi-moment-code-site-table">
                    <thead>
                        <tr>
                            <th class="sortable">Site</th>
                            <th class="sortable">Moment</th>
                            <th class="sortable">Step</th>
                            <th class="sortable">Code</th>
                            <th class="sortable" data-type="number">Somme Charge_NOK</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in evi_moment_code_site %}
                        <tr>
                            <td>{{ row["Site"] }}</td>
                            <td>{{ row["Moment"] }}</td>
                            <td>{{ row["Step"] }}</td>
                            <td>{{ row["Code"] }}</td>
                            <td style="text-align:right;">{{ row["Somme de Charge_NOK"] }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div style="padding:1rem; color:var(--color-text-muted); text-align:center;">Aucune donnée</div>
            {% endif %}
            {% else %}
            <div style="padding:1rem; color:var(--color-text-muted); text-align:center;">Aucune erreur EVI</div>
            {% endif %}
        </div>

        <div style="background:var(--color-surface); border:1px solid var(--color-border); border-radius:var(--radius); padding:1.5rem;">
            <h4 style="font-size:1.05rem; font-weight:700; margin:0 0 1rem 0; color:var(--color-text);">Downstream — Moment × Code PC</h4>
            {% if ds_moment_code %}
            <div class="mac-table-container">
                <table class="mac-table" id="ds-moment-code-table">
                    <thead>
                        <tr>
                            <th class="sortable">Moment</th>
                            <th class="sortable">Step</th>
                            <th class="sortable">Code PC</th>
                            <th class="sortable" data-type="number">Somme Charge_NOK</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in ds_moment_code %}
                        <tr>
                            <td>{{ row["Moment"] }}</td>
                            <td>{{ row["Step"] }}</td>
                            <td>{{ row["Code PC"] }}</td>
                            <td style="text-align:right;">{{ row["Somme de Charge_NOK"] }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <h4 style="font-size:1.05rem; font-weight:700; margin:1.5rem 0 1rem 0; color:var(--color-text);">Downstream — Moment × Code PC × Site</h4>
            {% if ds_moment_code_site %}
            <div class="mac-table-container">
                <table class="mac-table" id="ds-moment-code-site-table">
                    <thead>
                        <tr>
                            <th class="sortable">Site</th>
                            <th class="sortable">Moment</th>
                            <th class="sortable">Step</th>
                            <th class="sortable">Code PC</th>
                            <th class="sortable" data-type="number">Somme Charge_NOK</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in ds_moment_code_site %}
                        <tr>
                            <td>{{ row["Site"] }}</td>
                            <td>{{ row["Moment"] }}</td>
                            <td>{{ row["Step"] }}</td>
                            <td>{{ row["Code PC"] }}</td>
                            <td style="text-align:right;">{{ row["Somme de Charge_NOK"] }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div style="padding:1rem; color:var(--color-text-muted); text-align:center;">Aucune donnée</div>
            {% endif %}
            {% else %}
            <div style="padding:1rem; color:var(--color-text-muted); text-align:center;">Aucun Downstream</div>
            {% endif %}
        </div>
    </div>

    <!-- Résumé par site -->
    <div style="background:var(--color-surface); border:1px solid var(--color-border); border-radius:var(--radius); padding:1.5rem;">
        <h4 style="font-size:1.05rem; font-weight:700; margin:0 0 1rem 0; color:var(--color-text);">Résumé par site et phase</h4>
        {% if site_summary %}
        <div class="mac-table-container">
            <table class="mac-table" id="site-summary-table">
                <thead>
                    <tr>
                        <th class="sortable">Site</th>
                        <th class="sortable" data-type="number">Total</th>
                        <th class="sortable" data-type="number">OK</th>
                        <th class="sortable" data-type="number">NOK</th>
                        <th class="sortable" data-type="number">% Réussite</th>
                        <th class="sortable" data-type="number">% Erreurs</th>
                        <th class="sortable" data-type="number">Avant charge</th>
                        <th class="sortable" data-type="number">Charge</th>
                        <th class="sortable" data-type="number">Fin de charge</th>
                        <th class="sortable" data-type="number">Unknown</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in site_summary %}
                    <tr>
                        <td>{{ row["Site"] }}</td>
                        <td style="text-align:right;">{{ row["Total_Charges"] }}</td>
                        <td style="text-align:right;">{{ row["Charges_OK"] }}</td>
                        <td style="text-align:right;">{{ row["Charges_NOK"] }}</td>
                        <td style="text-align:right;" data-sort-value="{{ row['% Réussite'] }}">{{ '%.2f'|format(row['% Réussite']) }}</td>
                        <td style="text-align:right;" data-sort-value="{{ row['% Erreurs'] }}">{{ '%.2f'|format(row['% Erreurs']) }}</td>
                        <td style="text-align:right;">{{ row["Avant charge"]|int }}</td>
                        <td style="text-align:right;">{{ row["Charge"]|int }}</td>
                        <td style="text-align:right;">{{ row["Fin de charge"]|int }}</td>
                        <td style="text-align:right;">{{ row["Unknown"]|int }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div style="padding:1rem; color:var(--color-text-muted); text-align:center;">Aucun résumé</div>
        {% endif %}
    </div>

    <!-- Types d'erreur -->
    <div style="background:var(--color-surface); border:1px solid var(--color-border); border-radius:var(--radius); padding:1.5rem;">
        <h4 style="font-size:1.05rem; font-weight:700; margin:0 0 1rem 0; color:var(--color-text);">Répartition des types d'erreur</h4>
        {% if error_type_counts %}
        <div style="display:grid; grid-template-columns:1.4fr 0.6fr; gap:1rem; align-items:start;">
            <div class="mac-table-container" style="max-height:400px;">
                <table class="mac-table" id="error-type-table">
                    <thead>
                        <tr>
                            <th class="sortable">Type d'erreur</th>
                            <th class="sortable" data-type="number">Nb</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in error_type_counts %}
                        <tr>
                            <td>{{ row["type_erreur"] }}</td>
                            <td style="text-align:right;">{{ row["Nb"] }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="pie-card" data-pie-source="error-type-table">
                <div class="pie-chart"></div>
                <div class="pie-legend"></div>
            </div>
        </div>
        {% else %}
        <div style="padding:1rem; color:var(--color-text-muted); text-align:center;">Aucune erreur</div>
        {% endif %}
    </div>

    <!-- Moments d'erreur -->
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1.5rem;">
        <div style="background:var(--color-surface); border:1px solid var(--color-border); border-radius:var(--radius); padding:1.5rem;">
            <h4 style="font-size:1.05rem; font-weight:700; margin:0 0 1rem 0; color:var(--color-text);">Moments d'erreurs (EVI + Downstream)</h4>
            {% if moment_counts %}
            <div style="display:grid; grid-template-columns:1.4fr 0.6fr; gap:1rem; align-items:start;">
                <div class="mac-table-container" style="max-height:400px;">
                    <table class="mac-table" id="moment-table">
                        <thead>
                            <tr>
                                <th class="sortable">Moment</th>
                                <th class="sortable" data-type="number">Somme Charge_NOK</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in moment_counts %}
                            <tr>
                                <td>{{ row["moment"] }}</td>
                                <td style="text-align:right;">{{ row["Somme de Charge_NOK"] }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="pie-card" data-pie-source="moment-table">
                    <div class="pie-chart"></div>
                    <div class="pie-legend"></div>
                </div>
            </div>
            {% else %}
            <div style="padding:1rem; color:var(--color-text-muted); text-align:center;">Aucune erreur</div>
            {% endif %}
        </div>

        <div style="background:var(--color-surface); border:1px solid var(--color-border); border-radius:var(--radius); padding:1.5rem;">
            <h4 style="font-size:1.05rem; font-weight:700; margin:0 0 1rem 0; color:var(--color-text);">Moments d'erreurs (Avancé)</h4>
            {% if moment_adv_counts %}
            <div style="display:grid; grid-template-columns:1.4fr 0.6fr; gap:1rem; align-items:start;">
                <div class="mac-table-container" style="max-height:400px;">
                    <table class="mac-table" id="moment-adv-table">
                        <thead>
                            <tr>
                                <th class="sortable">Moment avancé</th>
                                <th class="sortable" data-type="number">Somme Charge_NOK</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in moment_adv_counts %}
                            <tr>
                                <td>{{ row["moment_avancee"] }}</td>
                                <td style="text-align:right;">{{ row["Somme de Charge_NOK"] }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div style="display:flex; flex-direction:column; gap:0.5rem;">
                    <div class="pie-card" data-pie-source="moment-adv-table">
                        <div class="pie-chart" style="width:120px; height:120px;"></div>
                        <div class="pie-legend" style="font-size:0.8rem;"></div>
                    </div>
                    <div class="bar-card" data-bar-source="moment-adv-table" style="padding:0.5rem;">
                        <div class="bar-chart"></div>
                    </div>
                </div>
            </div>
            {% else %}
            <div style="padding:1rem; color:var(--color-text-muted); text-align:center;">Aucune erreur</div>
            {% endif %}
        </div>
    </div>

    <!-- Répartition EVI + DS -->
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1.5rem;">
        <div style="background:var(--color-surface); border:1px solid var(--color-border); border-radius:var(--radius); padding:1.5rem;">
            <h4 style="font-size:1.05rem; font-weight:700; margin:0 0 1rem 0; color:var(--color-text);">Moments d'erreurs - EVI</h4>
            {% if evi_moment_distribution %}
            <div style="display:grid; grid-template-columns:1.4fr 0.6fr; gap:1rem; align-items:start;">
                <div class="mac-table-container">
                    <table class="mac-table" id="evi-moment-table">
                        <thead>
                            <tr>
                                <th class="sortable">Moment</th>
                                <th class="sortable" data-type="number">Nb</th>
                                <th class="sortable" data-type="number">%</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in evi_moment_distribution %}
                            <tr>
                                <td>{{ row["moment"] }}</td>
                                <td style="text-align:right;">{{ row["Nb"] }}</td>
                                <td style="text-align:right;" data-sort-value="{{ row['%'] }}">{{ '%.2f'|format(row['%']) }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="pie-card" data-pie-source="evi-moment-table">
                    <div class="pie-chart"></div>
                    <div class="pie-legend"></div>
                </div>
            </div>
            {% else %}
            <div style="padding:1rem; color:var(--color-text-muted); text-align:center;">Aucune erreur EVI</div>
            {% endif %}
        </div>

        <div style="background:var(--color-surface); border:1px solid var(--color-border); border-radius:var(--radius); padding:1.5rem;">
            <h4 style="font-size:1.05rem; font-weight:700; margin:0 0 1rem 0; color:var(--color-text);">Moments d'erreurs - EVI (avancée)</h4>
            {% if evi_moment_adv_distribution %}
            <div style="display:grid; grid-template-columns:1.4fr 0.6fr; gap:1rem; align-items:start;">
                <div class="mac-table-container">
                    <table class="mac-table" id="evi-adv-table">
                        <thead>
                            <tr>
                                <th class="sortable">Moment avancé</th>
                                <th class="sortable" data-type="number">Nb</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in evi_moment_adv_distribution %}
                            <tr>
                                <td>{{ row["moment_avancee"] }}</td>
                                <td style="text-align:right;">{{ row["Nb"] }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div style="display:flex; flex-direction:column; gap:1rem;">
                    <div class="pie-card" data-pie-source="evi-adv-table">
                        <div class="pie-chart"></div>
                        <div class="pie-legend"></div>
                    </div>
                    <div class="bar-card" data-bar-source="evi-adv-table">
                        <div class="bar-chart"></div>
                    </div>
                </div>
            </div>
            {% else %}
            <div style="padding:1rem; color:var(--color-text-muted); text-align:center;">Aucune erreur EVI avancée</div>
            {% endif %}
        </div>
    </div>

    <!-- Répartition DS -->
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1.5rem;">
        <div style="background:var(--color-surface); border:1px solid var(--color-border); border-radius:var(--radius); padding:1.5rem;">
            <h4 style="font-size:1.05rem; font-weight:700; margin:0 0 1rem 0; color:var(--color-text);">Moments d'erreurs - DownStream </h4>
            {% if ds_moment_distribution %}
            <div style="display:grid; grid-template-columns:1.4fr 0.6fr; gap:1rem; align-items:start;">
                <div class="mac-table-container">
                    <table class="mac-table" id="ds-moment-table">
                        <thead>
                            <tr>
                                <th class="sortable">Moment</th>
                                <th class="sortable" data-type="number">Nb</th>
                                <th class="sortable" data-type="number">%</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in ds_moment_distribution %}
                            <tr>
                                <td>{{ row["moment"] }}</td>
                                <td style="text-align:right;">{{ row["Nb"] }}</td>
                                <td style="text-align:right;" data-sort-value="{{ row['%'] }}">{{ '%.2f'|format(row['%']) }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="pie-card" data-pie-source="ds-moment-table">
                    <div class="pie-chart"></div>
                    <div class="pie-legend"></div>
                </div>
            </div>
            {% else %}
            <div style="padding:1rem; color:var(--color-text-muted); text-align:center;">Aucune erreur DownStream</div>
            {% endif %}
        </div>

        <div style="background:var(--color-surface); border:1px solid var(--color-border); border-radius:var(--radius); padding:1.5rem;">
            <h4 style="font-size:1.05rem; font-weight:700; margin:0 0 1rem 0; color:var(--color-text);">Moments d'erreur - DownStream (avancée)</h4>
            {% if ds_moment_adv_distribution %}
            <div style="display:grid; grid-template-columns:1.4fr 0.6fr; gap:1rem; align-items:start;">
                <div class="mac-table-container">
                    <table class="mac-table" id="ds-adv-table">
                        <thead>
                            <tr>
                                <th class="sortable">Moment avancé</th>
                                <th class="sortable" data-type="number">Nb</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in ds_moment_adv_distribution %}
                            <tr>
                                <td>{{ row["moment_avancee"] }}</td>
                                <td style="text-align:right;">{{ row["Nb"] }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div style="display:flex; flex-direction:column; gap:1rem;">
                    <div class="pie-card" data-pie-source="ds-adv-table">
                        <div class="pie-chart"></div>
                        <div class="pie-legend"></div>
                    </div>
                    <div class="bar-card" data-bar-source="ds-adv-table">
                        <div class="bar-chart"></div>
                    </div>
                </div>
            </div>
            {% else %}
            <div style="padding:1rem; color:var(--color-text-muted); text-align:center;">Aucune erreur DownStream avancée</div>
            {% endif %}
        </div>
    </div>
</div>

<script>
(function() {
    // Initialise le tri des tables et les graphiques
    if (typeof initTables === 'function') initTables();
    if (typeof initCharts === 'function') initCharts();
})();
</script>
{% endif %}
